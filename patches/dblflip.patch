From 1c860975b94d238a0204b2387b5f7510c3b7220b Mon Sep 17 00:00:00 2001
From: lj50036 <jl52741@gmail.com>
Date: Wed, 20 Apr 2016 13:33:57 -0500
Subject: [PATCH] WIP: Testing doubleflip fb

---
 minuitwrp/Android.mk         |  4 ++++
 minuitwrp/graphics_fbdev.cpp | 13 +++++++++++++
 2 files changed, 17 insertions(+)

diff --git a/minuitwrp/Android.mk b/minuitwrp/Android.mk
index 811685c..180100c 100644
--- a/minuitwrp/Android.mk
+++ b/minuitwrp/Android.mk
@@ -142,6 +142,10 @@ ifeq ($(BOARD_HAS_FLIPPED_SCREEN), true)
 LOCAL_CFLAGS += -DBOARD_HAS_FLIPPED_SCREEN
 endif
 
+ifeq ($(BOARD_USES_DOUBLEFLIP_FB),true)
+LOCAL_CFLAGS += -DUSES_DOUBLEFLIP_FB
+endif
+
 ifeq ($(TW_IGNORE_MAJOR_AXIS_0), true)
 LOCAL_CFLAGS += -DTW_IGNORE_MAJOR_AXIS_0
 endif
diff --git a/minuitwrp/graphics_fbdev.cpp b/minuitwrp/graphics_fbdev.cpp
index 066be8d..9a4279e 100644
--- a/minuitwrp/graphics_fbdev.cpp
+++ b/minuitwrp/graphics_fbdev.cpp
@@ -36,6 +36,9 @@
 
 static GRSurface* fbdev_init(minui_backend*);
 static GRSurface* fbdev_flip(minui_backend*);
+#ifdef USES_DOUBLEFLIP_FB
+static GRSurface* fbdev_doubleflip(minui_backend*);
+#endif
 static void fbdev_blank(minui_backend*, bool);
 static void fbdev_exit(minui_backend*);
 
@@ -50,7 +53,11 @@ static __u32 smem_len;
 
 static minui_backend my_backend = {
     .init = fbdev_init,
+#ifdef USES_DOUBLEFLIP_FB
+    .flip = fbdev_doubleflip,
+#else
     .flip = fbdev_flip,
+#endif
     .blank = fbdev_blank,
     .exit = fbdev_exit,
 };
@@ -316,6 +323,12 @@ static GRSurface* fbdev_flip(minui_backend* backend __unused) {
     return gr_draw;
 }
 
+#ifdef USES_DOUBLEFLIP_FB
+static GRSurface* fbdev_doubleflip(minui_backend* backend) {
+    fbdev_flip(backend);
+    return fbdev_flip(backend);
+}
+#endif
 static void fbdev_exit(minui_backend* backend __unused) {
     close(fb_fd);
     fb_fd = -1;
