From 68d5860ce7988b1aa28a22fb2e42883394e0dd19 Mon Sep 17 00:00:00 2001
From: buildbot <build@bot.com>
Date: Tue, 24 Nov 2015 15:13:23 -0600
Subject: [PATCH] Fix compile on Android

---
 Android.mk                                | 74 +++++++++++++++++++++++++++++++
 kexec/arch/arm/crashdump-arm.c            |  1 +
 kexec/arch/arm/include/kexec-fs2dt.h      |  7 +++
 kexec/arch/arm/kexec-zImage-arm.c         |  1 +
 kexec/arch/arm64/crashdump-arm64.c        |  1 +
 kexec/arch/arm64/include/kexec-fs2dt.h    |  7 +++
 kexec/arch/arm64/kexec-elf-arm64.c        |  1 +
 kexec/arch/arm64/kexec-gzip-image-arm64.c |  1 +
 kexec/arch/arm64/kexec-image-arm64.c      |  1 +
 kexec/crashdump-xen.c                     |  1 +
 kexec/dt-ops.c                            |  1 +
 kexec/firmware_memmap.c                   |  1 +
 kexec/fs2dt.c                             |  1 +
 kexec/fs2dt.h                             |  2 +
 kexec/ifdown.c                            |  1 +
 kexec/kexec-elf-boot.c                    |  1 +
 kexec/kexec-elf-core.c                    |  1 +
 kexec/kexec-elf-exec.c                    |  1 +
 kexec/kexec-elf-rel.c                     |  1 +
 kexec/kexec-elf.c                         |  1 +
 kexec/kexec-iomem.c                       |  1 +
 kexec/kexec-uImage.c                      |  1 +
 kexec/kexec-xen.c                         |  1 +
 kexec/kexec.c                             |  1 +
 kexec/kexec.h                             |  1 -
 kexec/virt_to_phys.c                      |  1 +
 kexec/zlib.c                              |  1 +
 purgatory/purgatory.c                     |  2 +
 version.h                                 |  1 +
 29 files changed, 114 insertions(+), 1 deletion(-)
 create mode 100644 Android.mk
 create mode 100644 kexec/arch/arm/include/kexec-fs2dt.h
 create mode 100644 kexec/arch/arm64/include/kexec-fs2dt.h
 create mode 100644 version.h

diff --git a/Android.mk b/Android.mk
new file mode 100644
index 0000000..eb14619
--- /dev/null
+++ b/Android.mk
@@ -0,0 +1,74 @@
+LOCAL_PATH := $(call my-dir)
+
+include $(CLEAR_VARS)
+LOCAL_MODULE                  := mrom_kdump_static
+LOCAL_MODULE_TAGS             := optional
+LOCAL_C_INCLUDES              := $(LOCAL_PATH)/include
+LOCAL_SRC_FILES               := kdump/kdump.c
+LOCAL_FORCE_STATIC_EXECUTABLE := true
+LOCAL_STATIC_LIBRARIES        := libc
+include $(BUILD_EXECUTABLE)
+
+include $(CLEAR_VARS)
+LOCAL_MODULE      := mrom_libutil_kt
+LOCAL_MODULE_TAGS := optional
+LOCAL_C_INCLUDES  := $(LOCAL_PATH)/util_lib/include
+LOCAL_SRC_FILES   := util_lib/compute_ip_checksum.c util_lib/sha256.c
+include $(BUILD_STATIC_LIBRARY)
+
+include $(CLEAR_VARS)
+LOCAL_MODULE                  := mrom_kexec_static
+LOCAL_MODULE_TAGS             := optional
+LOCAL_C_INCLUDES              := $(LOCAL_PATH)/include \
+                                 $(LOCAL_PATH)/util_lib/include \
+                                 $(LOCAL_PATH)/kexec/libfdt \
+                                 $(LOCAL_PATH)/kexec \
+                                 $(LOCAL_PATH)/purgatory/include \
+                                 external/zlib
+ifeq ($(TARGET_ARCH),arm64)
+LOCAL_C_INCLUDES              += $(LOCAL_PATH)/kexec/arch/arm64/include
+else
+LOCAL_C_INCLUDES              += $(LOCAL_PATH)/kexec/arch/arm/include
+endif
+LOCAL_SRC_FILES               := kexec/kexec.c kexec/ifdown.c \
+                                 kexec/kexec-elf.c kexec/kexec-elf-exec.c \
+                                 kexec/kexec-elf-core.c \
+                                 kexec/kexec-elf-rel.c \
+                                 kexec/kexec-elf-boot.c \
+                                 kexec/kexec-iomem.c \
+                                 kexec/firmware_memmap.c \
+                                 kexec/crashdump.c kexec/crashdump-xen.c \
+                                 kexec/phys_arch.c kexec/lzma.c \
+                                 kexec/zlib.c kexec/proc_iomem.c \
+                                 kexec/add_buffer.c \
+                                 kexec/kexec-uImage.c purgatory/purgatory.c \
+                                 kexec/dt-ops.c \
+                                 kexec/libfdt/fdt.c kexec/libfdt/fdt_ro.c \
+                                 kexec/libfdt/fdt_rw.c kexec/libfdt/fdt_strerror.c \
+                                 kexec/libfdt/fdt_sw.c kexec/libfdt/fdt_wip.c \
+                                 kexec/kexec-xen.c kexec/fs2dt.c
+ifeq ($(TARGET_ARCH),arm64)
+LOCAL_SRC_FILES               += kexec/arch/arm64/kexec-elf-arm64.c \
+                                 kexec/arch/arm64/kexec-image-arm64.c \
+                                 kexec/arch/arm64/kexec-arm64.c \
+                                 kexec/arch/arm64/crashdump-arm64.c \
+                                 kexec/arch/arm64/kexec-gzip-image-arm64.c \
+                                 purgatory/arch/arm64/purgatory-arm64.c \
+                                 purgatory/arch/arm64/entry.S
+else
+LOCAL_SRC_FILES               += kexec/arch/arm/phys_to_virt.c \
+                                 kexec/arch/arm/kexec-elf-rel-arm.c \
+                                 kexec/add_segment.c \
+                                 kexec/arch_reuse_initrd.c \
+                                 kexec/virt_to_phys.c \
+                                 kexec/arch/arm/kexec-zImage-arm.c \
+                                 kexec/arch/arm/kexec-uImage-arm.c \
+                                 kexec/arch/arm/kexec-arm.c \
+                                 kexec/arch/arm/crashdump-arm.c \
+                                 purgatory/string.c
+endif
+LOCAL_FORCE_STATIC_EXECUTABLE := true
+LOCAL_STATIC_LIBRARIES        := mrom_libutil_kt libz libc
+LOCAL_MODULE_PATH := $(TARGET_OUT_OPTIONAL_EXECUTABLES)
+LOCAL_UNSTRIPPED_PATH := $(TARGET_OUT_EXECUTABLES_UNSTRIPPED)
+include $(BUILD_EXECUTABLE)
diff --git a/kexec/arch/arm/crashdump-arm.c b/kexec/arch/arm/crashdump-arm.c
index b523e5f..dc16eb5 100644
--- a/kexec/arch/arm/crashdump-arm.c
+++ b/kexec/arch/arm/crashdump-arm.c
@@ -24,6 +24,7 @@
 #include <elf.h>
 #include <errno.h>
 #include <stdio.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include <unistd.h>
 
diff --git a/kexec/arch/arm/include/kexec-fs2dt.h b/kexec/arch/arm/include/kexec-fs2dt.h
new file mode 100644
index 0000000..04e6829
--- /dev/null
+++ b/kexec/arch/arm/include/kexec-fs2dt.h
@@ -0,0 +1,7 @@
+#ifndef KEXEC_FS2DT_H
+#define KEXEC_FS2DT_H
+
+#include "arch/arm/kexec-arm.h"
+#include "arch/arm/crashdump-arm.h"
+
+#endif /* KEXEC_FS2DT_H */
diff --git a/kexec/arch/arm/kexec-zImage-arm.c b/kexec/arch/arm/kexec-zImage-arm.c
index ff4e38d..5729726 100644
--- a/kexec/arch/arm/kexec-zImage-arm.c
+++ b/kexec/arch/arm/kexec-zImage-arm.c
@@ -6,6 +6,7 @@
 #define _XOPEN_SOURCE
 #include <stdio.h>
 #include <string.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include <errno.h>
 #include <limits.h>
diff --git a/kexec/arch/arm64/crashdump-arm64.c b/kexec/arch/arm64/crashdump-arm64.c
index 438afd5..e24340a 100644
--- a/kexec/arch/arm64/crashdump-arm64.c
+++ b/kexec/arch/arm64/crashdump-arm64.c
@@ -19,6 +19,7 @@
 
 #include <errno.h>
 #include <stdio.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include <unistd.h>
 #include <linux/elf.h>
diff --git a/kexec/arch/arm64/include/kexec-fs2dt.h b/kexec/arch/arm64/include/kexec-fs2dt.h
new file mode 100644
index 0000000..0599ef0
--- /dev/null
+++ b/kexec/arch/arm64/include/kexec-fs2dt.h
@@ -0,0 +1,7 @@
+#ifndef KEXEC_FS2DT_H
+#define KEXEC_FS2DT_H
+
+#include "arch/arm64/kexec-arm64.h"
+#include "arch/arm64/crashdump-arm64.h"
+
+#endif /* KEXEC_FS2DT_H */
diff --git a/kexec/arch/arm64/kexec-elf-arm64.c b/kexec/arch/arm64/kexec-elf-arm64.c
index 14a1940..ab5aeb2 100644
--- a/kexec/arch/arm64/kexec-elf-arm64.c
+++ b/kexec/arch/arm64/kexec-elf-arm64.c
@@ -8,6 +8,7 @@
 #include <errno.h>
 #include <getopt.h>
 #include <libfdt.h>
+#include <xlocale.h>
 #include <stdlib.h>
 
 #include <linux/elf.h>
diff --git a/kexec/arch/arm64/kexec-gzip-image-arm64.c b/kexec/arch/arm64/kexec-gzip-image-arm64.c
index df1d83e..8dd2ab1 100644
--- a/kexec/arch/arm64/kexec-gzip-image-arm64.c
+++ b/kexec/arch/arm64/kexec-gzip-image-arm64.c
@@ -8,6 +8,7 @@
 #include <errno.h>
 #include <getopt.h>
 #include <libfdt.h>
+#include <xlocale.h>
 #include <stdlib.h>
 
 #include "crashdump-arm64.h"
diff --git a/kexec/arch/arm64/kexec-image-arm64.c b/kexec/arch/arm64/kexec-image-arm64.c
index 23b5e8f..c65e4bd 100644
--- a/kexec/arch/arm64/kexec-image-arm64.c
+++ b/kexec/arch/arm64/kexec-image-arm64.c
@@ -8,6 +8,7 @@
 #include <errno.h>
 #include <getopt.h>
 #include <libfdt.h>
+#include <xlocale.h>
 #include <stdlib.h>
 
 #include "crashdump-arm64.h"
diff --git a/kexec/crashdump-xen.c b/kexec/crashdump-xen.c
index 60594f6..bfd94cd 100644
--- a/kexec/crashdump-xen.c
+++ b/kexec/crashdump-xen.c
@@ -2,6 +2,7 @@
 #include <stdio.h>
 #include <stdarg.h>
 #include <string.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include <elf.h>
 #include <errno.h>
diff --git a/kexec/dt-ops.c b/kexec/dt-ops.c
index 060776a..441d49e 100644
--- a/kexec/dt-ops.c
+++ b/kexec/dt-ops.c
@@ -3,6 +3,7 @@
 #include <inttypes.h>
 #include <libfdt.h>
 #include <stdio.h>
+#include <xlocale.h>
 #include <stdlib.h>
 
 #include "kexec.h"
diff --git a/kexec/firmware_memmap.c b/kexec/firmware_memmap.c
index 4d84f00..030ed6a 100644
--- a/kexec/firmware_memmap.c
+++ b/kexec/firmware_memmap.c
@@ -20,6 +20,7 @@
 #define _GNU_SOURCE /* for ULLONG_MAX without C99 */
 #include <stdio.h>
 #include <string.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include <dirent.h>
 #include <unistd.h>
diff --git a/kexec/fs2dt.c b/kexec/fs2dt.c
index 962d241..394b7a3 100644
--- a/kexec/fs2dt.c
+++ b/kexec/fs2dt.c
@@ -26,6 +26,7 @@
 #include <fcntl.h>
 #include <dirent.h>
 #include <unistd.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include <string.h>
 #include <errno.h>
diff --git a/kexec/fs2dt.h b/kexec/fs2dt.h
index 7633273..822a700 100644
--- a/kexec/fs2dt.h
+++ b/kexec/fs2dt.h
@@ -1,6 +1,8 @@
 #ifndef FS2DT_H
 #define FS2DT_H
 
+#include <kexec-fs2dt.h>
+
 #if (BOOT_BLOCK_VERSION != 2 && BOOT_BLOCK_VERSION != 17)
 #error Please add or correct definition of BOOT_BLOCK_VERSION
 #endif
diff --git a/kexec/ifdown.c b/kexec/ifdown.c
index 46b7bef..8419225 100644
--- a/kexec/ifdown.c
+++ b/kexec/ifdown.c
@@ -6,6 +6,7 @@
 char *v_ifdown = "@(#)ifdown.c  1.11  02-Jun-1998  miquels@cistron.nl";
 
 #include <stdio.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include <unistd.h>
 #include <time.h>
diff --git a/kexec/kexec-elf-boot.c b/kexec/kexec-elf-boot.c
index 38f9056..db4c927 100644
--- a/kexec/kexec-elf-boot.c
+++ b/kexec/kexec-elf-boot.c
@@ -20,6 +20,7 @@
 #define _GNU_SOURCE
 #include <stdio.h>
 #include <string.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include <errno.h>
 #include <elf.h>
diff --git a/kexec/kexec-elf-core.c b/kexec/kexec-elf-core.c
index a341fdb..a6245fb 100644
--- a/kexec/kexec-elf-core.c
+++ b/kexec/kexec-elf-core.c
@@ -1,6 +1,7 @@
 #include <stdio.h>
 #include <stdint.h>
 #include <errno.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include "elf.h"
 #include "kexec-elf.h"
diff --git a/kexec/kexec-elf-exec.c b/kexec/kexec-elf-exec.c
index cb62d04..651c80d 100644
--- a/kexec/kexec-elf-exec.c
+++ b/kexec/kexec-elf-exec.c
@@ -3,6 +3,7 @@
 #include <string.h>
 #include <stdio.h>
 #include <errno.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include "elf.h"
 #include <boot/elf_boot.h>
diff --git a/kexec/kexec-elf-rel.c b/kexec/kexec-elf-rel.c
index c625f30..8de59ae 100644
--- a/kexec/kexec-elf-rel.c
+++ b/kexec/kexec-elf-rel.c
@@ -1,6 +1,7 @@
 #include <limits.h>
 #include <stdint.h>
 #include <string.h>
+#include <xlocale.h>
 #include <stdio.h>
 #include <errno.h>
 #include <stdlib.h>
diff --git a/kexec/kexec-elf.c b/kexec/kexec-elf.c
index 3515203..72aaefc 100644
--- a/kexec/kexec-elf.c
+++ b/kexec/kexec-elf.c
@@ -3,6 +3,7 @@
 #include <string.h>
 #include <stdio.h>
 #include <errno.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include "elf.h"
 #include <boot/elf_boot.h>
diff --git a/kexec/kexec-iomem.c b/kexec/kexec-iomem.c
index 485a2e8..5d6bc10 100644
--- a/kexec/kexec-iomem.c
+++ b/kexec/kexec-iomem.c
@@ -2,6 +2,7 @@
 #include <stdio.h>
 #include <stdarg.h>
 #include <string.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include <errno.h>
 #include <limits.h>
diff --git a/kexec/kexec-uImage.c b/kexec/kexec-uImage.c
index 00bc064..dc2e3bb 100644
--- a/kexec/kexec-uImage.c
+++ b/kexec/kexec-uImage.c
@@ -1,4 +1,5 @@
 #define _GNU_SOURCE
+#include <xlocale.h>
 #include <stdlib.h>
 #include <stdint.h>
 #include <string.h>
diff --git a/kexec/kexec-xen.c b/kexec/kexec-xen.c
index 24a4191..ebc54a5 100644
--- a/kexec/kexec-xen.c
+++ b/kexec/kexec-xen.c
@@ -1,6 +1,7 @@
 #define _GNU_SOURCE
 #include <stdio.h>
 #include <string.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include <elf.h>
 #include "kexec.h"
diff --git a/kexec/kexec.c b/kexec/kexec.c
index 2e9b549..2a19729 100644
--- a/kexec/kexec.c
+++ b/kexec/kexec.c
@@ -23,6 +23,7 @@
 #include <stdio.h>
 #include <stdarg.h>
 #include <string.h>
+#include <xlocale.h>
 #include <stdlib.h>
 #include <errno.h>
 #include <limits.h>
diff --git a/kexec/virt_to_phys.c b/kexec/virt_to_phys.c
index a746917..09ab122 100644
--- a/kexec/virt_to_phys.c
+++ b/kexec/virt_to_phys.c
@@ -1,4 +1,5 @@
 #include "kexec.h"
+#include <xlocale.h>
 #include <stdlib.h>
 
 unsigned long virt_to_phys(unsigned long UNUSED(addr))
diff --git a/kexec/zlib.c b/kexec/zlib.c
index 7170ac3..ab6389f 100644
--- a/kexec/zlib.c
+++ b/kexec/zlib.c
@@ -3,6 +3,7 @@
 
 #ifdef HAVE_LIBZ
 #define _GNU_SOURCE
+#include <xlocale.h>
 #include <stdio.h>
 #include <stdarg.h>
 #include <string.h>
diff --git a/purgatory/purgatory.c b/purgatory/purgatory.c
index 7e99b92..17a582f 100644
--- a/purgatory/purgatory.c
+++ b/purgatory/purgatory.c
@@ -51,3 +51,5 @@ void purgatory(void)
 	}
 	post_verification_setup_arch();
 }
+
+size_t purgatory_size = sizeof(purgatory);
diff --git a/version.h b/version.h
new file mode 100644
index 0000000..6b5a6f8
--- /dev/null
+++ b/version.h
@@ -0,0 +1 @@
+#define VERSION "15.11.23.21.39-gdd7d472-dirty"
-- 
2.5.0

