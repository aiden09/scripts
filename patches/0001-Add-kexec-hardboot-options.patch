From dd7d472cef005e47e911d89244dcb5b6752473bb Mon Sep 17 00:00:00 2001
From: Mike Kasick <mike@kasick.org>
Date: Fri, 27 Sep 2013 19:03:52 +0200
Subject: [PATCH 1/3] Add kexec-hardboot options

---
 kexec/kexec-syscall.h |  1 +
 kexec/kexec.c         | 12 ++++++++++++
 kexec/kexec.h         |  4 +++-
 3 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/kexec/kexec-syscall.h b/kexec/kexec-syscall.h
index 267b75b..615c78f 100644
--- a/kexec/kexec-syscall.h
+++ b/kexec/kexec-syscall.h
@@ -90,6 +90,7 @@ static inline long kexec_file_load(int kernel_fd, int initrd_fd,
 
 #define KEXEC_ON_CRASH		0x00000001
 #define KEXEC_PRESERVE_CONTEXT	0x00000002
+#define KEXEC_HARDBOOT		0x00000004
 #define KEXEC_ARCH_MASK		0xffff0000
 
 /* Flags for kexec file based system call */
diff --git a/kexec/kexec.c b/kexec/kexec.c
index 2e9b549..ff1acfd 100644
--- a/kexec/kexec.c
+++ b/kexec/kexec.c
@@ -986,6 +986,7 @@ void usage(void)
 	       "                      to original kernel.\n"
 	       " -s, --kexec-file-syscall Use file based syscall for kexec operation\n"
 	       " -d, --debug           Enable debugging to help spot a failure.\n"
+	       "     --load-hardboot  Load the new kernel and hard boot it.\n"
 	       "\n"
 	       "Supported kernel file types and options: \n");
 	for (i = 0; i < file_types; i++) {
@@ -1366,6 +1367,11 @@ int main(int argc, char *argv[])
 			break;
 		case OPT_LITE:
 			do_lite = 1;
+		case OPT_LOAD_HARDBOOT:
+			do_load = 1;
+			do_exec = 0;
+			do_shutdown = 0;
+			kexec_flags = KEXEC_HARDBOOT;
 			break;
 		default:
 			break;
@@ -1392,6 +1398,12 @@ int main(int argc, char *argv[])
 		    "\"--mem-max\" parameter\n");
 	}
 
+	if (do_load && (kexec_flags & KEXEC_HARDBOOT) && mem_min == 0) {
+		printf("Please specify memory range used by kexeced kernel\n");
+		printf("to avoid being overwritten by on reboot with the\n");
+		die("\"--min-max\" parameter\n");
+	}
+
 	fileind = optind;
 	/* Reset getopt for the next pass; called in other source modules */
 	opterr = 1;
diff --git a/kexec/kexec.h b/kexec/kexec.h
index a547e93..783a1c7 100644
--- a/kexec/kexec.h
+++ b/kexec/kexec.h
@@ -227,7 +227,8 @@ extern int file_types;
 #define OPT_LOAD_PRESERVE_CONTEXT 259
 #define OPT_LOAD_JUMP_BACK_HELPER 260
 #define OPT_ENTRY		261
-#define OPT_MAX			262
+#define OPT_LOAD_HARDBOOT	262
+#define OPT_MAX			263
 #define KEXEC_OPTIONS \
 	{ "help",		0, 0, OPT_HELP }, \
 	{ "version",		0, 0, OPT_VERSION }, \
@@ -248,6 +249,7 @@ extern int file_types;
 	{ "kexec-file-syscall",	0, 0, OPT_KEXEC_FILE_SYSCALL }, \
 	{ "lite",		0, 0, OPT_LITE }, \
 	{ "debug",		0, 0, OPT_DEBUG }, \
+	{ "load-hardboot",	0, 0, OPT_LOAD_HARDBOOT}, \
 
 #define KEXEC_OPT_STR "h?vdfxyluet:ps"
 
-- 
2.5.0

